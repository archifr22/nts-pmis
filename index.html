<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMIS - ê±´ì„¤ì‚¬ì—…ê´€ë¦¬ì‹œìŠ¤í…œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            background-attachment: fixed;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
        }

        .hidden { display: none !important; }
        .container { max-width: 500px; margin: 0 auto; padding: 16px; }
        .app-container { max-width: 1600px; margin: 0 auto; padding: 16px; }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
        }

        .glass-dark {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            color: #fff;
            font-size: 14px;
        }

        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-success { background: linear-gradient(135deg, #56ab2f, #a8e063); }
        .btn-danger { background: linear-gradient(135deg, #eb3349, #f45c43); }
        .btn-sm { padding: 8px 16px; font-size: 12px; }
        .btn-block { width: 100%; }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: #fff;
            font-size: 14px;
            white-space: nowrap;
        }

        .tab.active { background: linear-gradient(135deg, #667eea, #764ba2); }

        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-safe { background: #56ab2f; }
        .badge-caution { background: #f9d423; color: #000; }
        .badge-warning { background: #ff9966; }
        .badge-critical { background: #eb3349; }
        .role-admin { background: #f093fb; }

        input, select, textarea {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            color: #fff;
            width: 100%;
            font-size: 14px;
        }

        input::placeholder { color: rgba(255, 255, 255, 0.5); }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea { min-height: 80px; }
        label { display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active { display: block; }

        .modal-content {
            background: rgba(15, 12, 41, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 30px;
            max-width: 900px;
            margin: 40px auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
        }

        .modal-close {
            font-size: 28px;
            cursor: pointer;
            background: none;
            border: none;
            color: #fff;
        }

        .form-group { margin-bottom: 16px; }
        .form-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .form-section-title {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 16px;
            color: #a8edea;
        }

        .site-card {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        /* WBS íŠ¸ë¦¬ êµ¬ì¡° */
        .wbs-item {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid #667eea;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .wbs-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
        }

        .wbs-item.level-0 { margin-left: 0; border-left-color: #667eea; }
        .wbs-item.level-1 { margin-left: 30px; border-left-color: #56ab2f; }
        .wbs-item.level-2 { margin-left: 60px; border-left-color: #f9d423; }

        .wbs-code {
            font-weight: 700;
            color: #a8edea;
            margin-right: 12px;
        }

        /* EVM */
        .evm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .evm-card {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .evm-label { font-size: 0.875rem; color: #9ca3af; margin-bottom: 8px; }
        .evm-value { font-size: 2rem; font-weight: 700; margin-top: 8px; }
        .evm-value.good { color: #56ab2f; }
        .evm-value.bad { color: #eb3349; }
        .evm-value.normal { color: #f9d423; }

        .gauge-container {
            width: 150px;
            height: 100px;
            margin: 20px auto;
            position: relative;
        }

        .gauge-label {
            position: absolute;
            top: 70%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.8rem;
            font-weight: 700;
        }

        .min-h-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .text-center { text-align: center; }
        .text-muted { color: #9ca3af; }
        .mb-4 { margin-bottom: 16px; }
        .mb-6 { margin-bottom: 24px; }
        .mt-4 { margin-top: 16px; }
        .p-4 { padding: 16px; }
        .p-6 { padding: 24px; }
        .p-8 { padding: 32px; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-2 { gap: 8px; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }

        .logo-title { font-size: 2.5rem; font-weight: 700; margin-bottom: 8px; }
        .logo-subtitle { font-size: 1.125rem; color: #d1d5db; margin-bottom: 4px; }
        .logo-desc { font-size: 0.875rem; color: #9ca3af; margin-bottom: 32px; }

        .app-header {
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-nav {
            padding: 16px;
            margin-bottom: 16px;
            overflow-x: auto;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            min-width: max-content;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .section-title { font-size: 1.5rem; font-weight: 700; }
        .section-content { padding: 24px; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in { animation: fadeIn 0.5s; }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen" class="min-h-screen">
        <div class="container">
            <div class="glass p-8 fade-in">
                <div class="text-center">
                    <h1 class="logo-title">ğŸ—ï¸ PMIS</h1>
                    <p class="logo-subtitle">ê±´ì„¤ì‚¬ì—…ê´€ë¦¬ì‹œìŠ¤í…œ</p>
                    <p class="logo-desc">WBS ê¸°ë°˜ EVM í†µí•© í”Œë«í¼</p>
                </div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label>ì´ë©”ì¼</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group mb-6">
                        <label>ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">ë¡œê·¸ì¸</button>
                    <p class="text-muted text-center mt-4" style="font-size: 0.75rem;">
                        ê´€ë¦¬ì: admin@pmis.com / 1234
                    </p>
                </form>
                <div id="loginMessage" class="mt-4 text-center"></div>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì•± -->
    <div id="appScreen" class="hidden">
        <div class="app-container">
            <header class="app-header glass">
                <div>
                    <h2 style="font-size: 1.25rem; font-weight: 700;">ğŸ—ï¸ PMIS</h2>
                    <p id="userInfo" style="font-size: 0.875rem; color: #d1d5db;"></p>
                </div>
                <button onclick="logout()" class="btn btn-danger btn-sm">ë¡œê·¸ì•„ì›ƒ</button>
            </header>

            <nav class="app-nav glass">
                <div class="nav-tabs">
                    <button class="tab active" onclick="switchTab('dashboard')">ëŒ€ì‹œë³´ë“œ</button>
                    <button class="tab" onclick="switchTab('sites')">í˜„ì¥ê´€ë¦¬</button>
                    <button class="tab" onclick="switchTab('wbs')">WBS</button>
                    <button class="tab" onclick="switchTab('daily')">ì‘ì—…ì¼ë³´</button>
                    <button class="tab" onclick="switchTab('evm')">EVM ë¶„ì„</button>
                    <button class="tab" onclick="switchTab('safety')">ì•ˆì „ê´€ë¦¬</button>
                </div>
            </nav>

            <!-- ëŒ€ì‹œë³´ë“œ -->
            <div id="contentDashboard" style="padding: 0 16px;">
                <div class="glass-dark section-content">
                    <h3 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 16px;">í˜„ì¥ ëª©ë¡</h3>
                    <div id="dashSiteList"></div>
                </div>
            </div>

            <!-- í˜„ì¥ê´€ë¦¬ -->
            <div id="contentSites" class="hidden" style="padding: 0 16px;">
                <div class="section-header">
                    <h2 class="section-title">í˜„ì¥ ê´€ë¦¬</h2>
                    <button onclick="openSiteModal()" class="btn btn-primary">+ í˜„ì¥ ì¶”ê°€</button>
                </div>
                <div id="sitesList"></div>
            </div>

            <!-- WBS -->
            <div id="contentWBS" class="hidden" style="padding: 0 16px;">
                <div class="section-header">
                    <h2 class="section-title">WBS ì‘ì—…ë¶„ë¥˜ì²´ê³„</h2>
                    <button onclick="openWBSModal()" class="btn btn-primary">+ WBS ì¶”ê°€</button>
                </div>
                <div class="glass-dark section-content">
                    <div id="wbsTree"></div>
                </div>
            </div>

            <!-- ì‘ì—…ì¼ë³´ -->
            <div id="contentDaily" class="hidden" style="padding: 0 16px;">
                <div class="section-header">
                    <h2 class="section-title">ì‘ì—…ì¼ë³´</h2>
                    <button onclick="openDailyModal()" class="btn btn-primary">+ ì¼ë³´ ì‘ì„±</button>
                </div>
                <div class="glass-dark section-content">
                    <div id="dailyList"></div>
                </div>
            </div>

            <!-- EVM ë¶„ì„ -->
            <div id="contentEVM" class="hidden" style="padding: 0 16px;">
                <h2 class="section-title mb-4">EVM ê¸°ì„±ê³  ê´€ë¦¬</h2>
                
                <div class="evm-grid">
                    <div class="evm-card">
                        <div class="evm-label">BAC (ì´ ì˜ˆì‚°)</div>
                        <div class="evm-value" id="evmBAC">0ì–µ</div>
                    </div>
                    <div class="evm-card">
                        <div class="evm-label">PV (ê³„íš ê¸°ì„±)</div>
                        <div class="evm-value" id="evmPV">0ì–µ</div>
                    </div>
                    <div class="evm-card">
                        <div class="evm-label">EV (ì‹¤ì  ê¸°ì„±)</div>
                        <div class="evm-value" id="evmEV">0ì–µ</div>
                    </div>
                    <div class="evm-card">
                        <div class="evm-label">AC (ì‹¤íˆ¬ì…ë¹„)</div>
                        <div class="evm-value" id="evmAC">0ì–µ</div>
                    </div>
                </div>

                <div class="grid-2" style="margin-bottom: 24px;">
                    <div class="glass-dark p-6">
                        <h3 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 16px; text-align: center;">
                            SPI (ì¼ì • ì„±ê³¼)
                        </h3>
                        <div class="gauge-container" id="spiGauge">
                            <div class="gauge-label" id="spiValue">0.00</div>
                        </div>
                        <p id="spiStatus" class="text-center text-muted"></p>
                    </div>
                    <div class="glass-dark p-6">
                        <h3 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 16px; text-align: center;">
                            CPI (ì›ê°€ ì„±ê³¼)
                        </h3>
                        <div class="gauge-container" id="cpiGauge">
                            <div class="gauge-label" id="cpiValue">0.00</div>
                        </div>
                        <p id="cpiStatus" class="text-center text-muted"></p>
                    </div>
                </div>

                <div class="glass-dark p-6">
                    <h3 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 16px;">S-Curve (ëˆ„ì  ê³µì • ê³¡ì„ )</h3>
                    <svg id="sCurveSvg" style="width: 100%; height: 300px;"></svg>
                </div>
            </div>

            <!-- ì•ˆì „ê´€ë¦¬ -->
            <div id="contentSafety" class="hidden" style="padding: 0 16px;">
                <div class="section-header">
                    <h2 class="section-title">ì•ˆì „ê´€ë¦¬</h2>
                    <button onclick="openRiskModal()" class="btn btn-primary">+ ìœ„í—˜ì„±í‰ê°€</button>
                </div>
                <div class="glass-dark section-content">
                    <div id="riskList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ë“¤ -->
    <div id="siteModal" class="modal"></div>
    <div id="wbsModal" class="modal"></div>
    <div id="dailyModal" class="modal"></div>
    <div id="riskModal" class="modal"></div>

    <script>
        let currentUser = null;

        const Storage = {
            get(key) {
                try { return JSON.parse(localStorage.getItem(key)) || []; }
                catch (e) { return []; }
            },
            set(key, value) {
                try { localStorage.setItem(key, JSON.stringify(value)); return true; }
                catch (e) { alert('ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'); return false; }
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            initAdminAccount();
            const loginForm = document.getElementById('loginForm');
            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            restoreSession();
        });

        function initAdminAccount() {
            const users = Storage.get('users');
            if (!users.find(u => u.email === 'admin@pmis.com')) {
                users.push({
                    id: 'admin-001',
                    email: 'admin@pmis.com',
                    password: '1234',
                    name: 'ì‹œìŠ¤í…œ ê´€ë¦¬ì',
                    role: 'admin',
                    approved: true
                });
                Storage.set('users', users);
            }
        }

        window.handleLogin = function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const users = Storage.get('users');
            const user = users.find(u => u.email === email && u.password === password && u.approved);

            if (!user) {
                const msg = document.getElementById('loginMessage');
                msg.textContent = 'ë¡œê·¸ì¸ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                msg.style.color = '#f87171';
                return;
            }

            currentUser = user;
            Storage.set('currentUser', user);
            showApp();
        };

        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('userInfo').innerHTML = `<span class="badge role-admin">ê´€ë¦¬ì</span> ${currentUser.name}`;
            loadDashboard();
        }

        function restoreSession() {
            const saved = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (saved && saved.id) {
                const users = Storage.get('users');
                const user = users.find(u => u.id === saved.id && u.approved);
                if (user) {
                    currentUser = user;
                    showApp();
                }
            }
        }

        window.logout = function() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                currentUser = null;
                localStorage.removeItem('currentUser');
                document.getElementById('appScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('loginForm').reset();
            }
        };

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            ['Dashboard', 'Sites', 'WBS', 'Daily', 'EVM', 'Safety'].forEach(name => {
                const el = document.getElementById('content' + name);
                if (el) el.classList.add('hidden');
            });
            event.target.classList.add('active');
            const contentId = 'content' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
            const content = document.getElementById(contentId);
            if (content) content.classList.remove('hidden');
            
            if (tabName === 'dashboard') loadDashboard();
            else if (tabName === 'sites') loadSites();
            else if (tabName === 'wbs') loadWBS();
            else if (tabName === 'daily') loadDaily();
            else if (tabName === 'evm') loadEVM();
            else if (tabName === 'safety') loadSafety();
        };

        function loadDashboard() {
            const sites = Storage.get('sites');
            const container = document.getElementById('dashSiteList');
            if (!container) return;

            if (sites.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">ë“±ë¡ëœ í˜„ì¥ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            container.innerHTML = sites.map(site => {
                const ratio = site.plannedProgress > 0 ? Math.round((site.actualProgress / site.plannedProgress) * 100) : 100;
                let statusClass = 'badge-safe';
                if (ratio < 90) statusClass = 'badge-critical';
                else if (ratio < 95) statusClass = 'badge-warning';
                else if (ratio < 100) statusClass = 'badge-caution';

                return `
                    <div class="site-card">
                        <div class="flex justify-between items-center">
                            <div style="flex: 1;">
                                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 8px;">${site.name}</h3>
                                <p class="text-muted" style="margin-bottom: 12px;">${site.startDate} ~ ${site.endDate}</p>
                                <p>ê³„íš: ${site.plannedProgress}% | ì‹¤ì œ: ${site.actualProgress}%</p>
                            </div>
                            <span class="badge ${statusClass}">${ratio}%</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadSites() {
            loadDashboard();
            const dash = document.getElementById('dashSiteList');
            const sites = document.getElementById('sitesList');
            if (dash && sites) sites.innerHTML = dash.innerHTML;
        }

        window.openSiteModal = function() {
            const modal = document.getElementById('siteModal');
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 style="font-size: 1.5rem; font-weight: 700;">í˜„ì¥ ë“±ë¡</h3>
                        <button onclick="closeModal('siteModal')" class="modal-close">&times;</button>
                    </div>
                    <form onsubmit="saveSite(event)">
                        <div class="form-section">
                            <div class="form-section-title">ê¸°ë³¸ ì •ë³´</div>
                            <div class="form-group">
                                <label>ê³µì‚¬ëª… *</label>
                                <input type="text" id="siteName" required>
                            </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>ì‹œì‘ì¼ *</label>
                                    <input type="date" id="siteStartDate" required>
                                </div>
                                <div class="form-group">
                                    <label>ì¢…ë£Œì¼ *</label>
                                    <input type="date" id="siteEndDate" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-section">
                            <div class="form-section-title">ê³µì •ë¥ </div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>ê³„íš ê³µì •ë¥  (%)</label>
                                    <input type="number" id="plannedProgress" min="0" max="100" value="0">
                                </div>
                                <div class="form-group">
                                    <label>ì‹¤ì œ ê³µì •ë¥  (%)</label>
                                    <input type="number" id="actualProgress" min="0" max="100" value="0">
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-success" style="flex: 1;">ì €ì¥</button>
                            <button type="button" onclick="closeModal('siteModal')" class="btn btn-danger" style="flex: 1;">ì·¨ì†Œ</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.add('active');
        };

        window.saveSite = function(e) {
            e.preventDefault();
            const sites = Storage.get('sites');
            sites.push({
                id: 'site-' + Date.now(),
                name: document.getElementById('siteName').value,
                startDate: document.getElementById('siteStartDate').value,
                endDate: document.getElementById('siteEndDate').value,
                plannedProgress: parseInt(document.getElementById('plannedProgress').value) || 0,
                actualProgress: parseInt(document.getElementById('actualProgress').value) || 0,
                ownerId: currentUser.id,
                createdAt: new Date().toISOString()
            });
            Storage.set('sites', sites);
            closeModal('siteModal');
            loadSites();
            loadDashboard();
            alert('í˜„ì¥ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        };

        // ==================== WBS ====================
        function loadWBS() {
            const wbsItems = Storage.get('wbs');
            const container = document.getElementById('wbsTree');
            if (!container) return;

            if (wbsItems.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">ë“±ë¡ëœ WBSê°€ ì—†ìŠµë‹ˆë‹¤<br><small>+ WBS ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‘ì—…ì„ ë“±ë¡í•˜ì„¸ìš”</small></div>';
                return;
            }

            const sorted = wbsItems.sort((a, b) => a.code.localeCompare(b.code, undefined, { numeric: true }));

            container.innerHTML = sorted.map(wbs => {
                const level = (wbs.code.match(/\./g) || []).length;
                return `
                    <div class="wbs-item level-${level}">
                        <div class="flex justify-between items-center">
                            <div style="flex: 1;">
                                <span class="wbs-code">${wbs.code}</span>
                                <span>${wbs.name}</span>
                            </div>
                            <div style="font-size: 0.875rem; color: #9ca3af;">
                                ì˜ˆì‚°: ${(wbs.budget || 0).toLocaleString()}ë°±ë§Œ | 
                                ì§„í–‰ë¥ : ${wbs.progress || 0}% | 
                                ê°€ì¤‘ì¹˜: ${wbs.weight || 0}% |
                                ì‹¤íˆ¬ì…: ${(wbs.actualCost || 0).toLocaleString()}ë°±ë§Œ
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.openWBSModal = function() {
            const modal = document.getElementById('wbsModal');
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 style="font-size: 1.5rem; font-weight: 700;">WBS ì¶”ê°€</h3>
                        <button onclick="closeModal('wbsModal')" class="modal-close">&times;</button>
                    </div>
                    <form onsubmit="saveWBS(event)">
                        <div class="form-section">
                            <div class="form-section-title">WBS ì •ë³´</div>
                            <div class="form-group">
                                <label>WBS ì½”ë“œ * (ì˜ˆ: 1, 1.1, 1.1.1)</label>
                                <input type="text" id="wbsCode" required placeholder="1.1.1">
                            </div>
                            <div class="form-group">
                                <label>ì‘ì—…ëª… *</label>
                                <input type="text" id="wbsName" required>
                            </div>
                        </div>
                        <div class="form-section">
                            <div class="form-section-title">ì˜ˆì‚° ë° ì›ê°€</div>
                            <div class="grid-3">
                                <div class="form-group">
                                    <label>ì˜ˆì‚° (BAC, ë°±ë§Œì›) *</label>
                                    <input type="number" id="wbsBudget" value="0" min="0" required>
                                </div>
                                <div class="form-group">
                                    <label>ì‹¤íˆ¬ì…ë¹„ (AC, ë°±ë§Œì›)</label>
                                    <input type="number" id="wbsActualCost" value="0" min="0">
                                </div>
                                <div class="form-group">
                                    <label>ê°€ì¤‘ì¹˜ (%)</label>
                                    <input type="number" id="wbsWeight" value="0" min="0" max="100">
                                </div>
                            </div>
                        </div>
                        <div class="form-section">
                            <div class="form-section-title">ê³µì • ì •ë³´</div>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>ê³„íš ê³µì •ë¥  (%)</label>
                                    <input type="number" id="wbsPlannedProgress" value="0" min="0" max="100">
                                </div>
                                <div class="form-group">
                                    <label>ì‹¤ì  ê³µì •ë¥  (%)</label>
                                    <input type="number" id="wbsProgress" value="0" min="0" max="100">
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-success" style="flex: 1;">ì €ì¥</button>
                            <button type="button" onclick="closeModal('wbsModal')" class="btn btn-danger" style="flex: 1;">ì·¨ì†Œ</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.add('active');
        };

        window.saveWBS = function(e) {
            e.preventDefault();
            const wbs = Storage.get('wbs');
            wbs.push({
                id: 'wbs-' + Date.now(),
                code: document.getElementById('wbsCode').value,
                name: document.getElementById('wbsName').value,
                budget: parseFloat(document.getElementById('wbsBudget').value) || 0,
                actualCost: parseFloat(document.getElementById('wbsActualCost').value) || 0,
                weight: parseFloat(document.getElementById('wbsWeight').value) || 0,
                plannedProgress: parseFloat(document.getElementById('wbsPlannedProgress').value) || 0,
                progress: parseFloat(document.getElementById('wbsProgress').value) || 0,
                createdAt: new Date().toISOString()
            });
            Storage.set('wbs', wbs);
            closeModal('wbsModal');
            loadWBS();
            loadEVM();
            alert('WBSê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        };

        // ==================== EVM ====================
        function loadEVM() {
            const wbs = Storage.get('wbs');
            
            if (wbs.length === 0) {
                document.getElementById('evmBAC').textContent = '0ì–µ';
                document.getElementById('evmPV').textContent = '0ì–µ';
                document.getElementById('evmEV').textContent = '0ì–µ';
                document.getElementById('evmAC').textContent = '0ì–µ';
                document.getElementById('spiValue').textContent = '0.00';
                document.getElementById('cpiValue').textContent = '0.00';
                return;
            }

            // BAC (ì´ ì˜ˆì‚°)
            const bac = wbs.reduce((sum, w) => sum + (w.budget || 0), 0);

            // ê°€ì¤‘ì¹˜ ì´í•©
            const totalWeight = wbs.reduce((sum, w) => sum + (w.weight || 0), 0);
            const avgWeight = totalWeight > 0 ? totalWeight / wbs.length : 1;

            // PV (ê³„íš ê¸°ì„±) = Î£(ì˜ˆì‚° Ã— ê³„íšê³µì •ë¥  / 100)
            const pv = wbs.reduce((sum, w) => {
                return sum + (w.budget || 0) * (w.plannedProgress || 0) / 100;
            }, 0);

            // EV (ì‹¤ì  ê¸°ì„±) = Î£(ì˜ˆì‚° Ã— ì‹¤ì ê³µì •ë¥  / 100)
            const ev = wbs.reduce((sum, w) => {
                return sum + (w.budget || 0) * (w.progress || 0) / 100;
            }, 0);

            // AC (ì‹¤íˆ¬ì…ë¹„)
            const ac = wbs.reduce((sum, w) => sum + (w.actualCost || 0), 0);

            // SPI = EV / PV
            const spi = pv > 0 ? ev / pv : 0;

            // CPI = EV / AC
            const cpi = ac > 0 ? ev / ac : 0;

            // í™”ë©´ ì—…ë°ì´íŠ¸
            document.getElementById('evmBAC').textContent = (bac / 100).toFixed(1) + 'ì–µ';
            document.getElementById('evmPV').textContent = (pv / 100).toFixed(1) + 'ì–µ';
            document.getElementById('evmEV').textContent = (ev / 100).toFixed(1) + 'ì–µ';
            document.getElementById('evmAC').textContent = (ac / 100).toFixed(1) + 'ì–µ';

            // SPI
            const spiEl = document.getElementById('spiValue');
            spiEl.textContent = spi.toFixed(2);
            spiEl.className = 'gauge-label ' + (spi >= 1.0 ? 'good' : spi >= 0.9 ? 'normal' : 'bad');
            
            const spiStatus = document.getElementById('spiStatus');
            if (spi >= 1.0) {
                spiStatus.textContent = 'âœ… ê³µê¸° ë‹¨ì¶• (ì¼ì • ì•ë‹¹ê¹€)';
                spiStatus.style.color = '#56ab2f';
            } else if (spi >= 0.9) {
                spiStatus.textContent = 'âš ï¸ ì •ìƒ ë²”ìœ„ (ì¼ì • ì¤€ìˆ˜)';
                spiStatus.style.color = '#f9d423';
            } else {
                spiStatus.textContent = 'âŒ ê³µê¸° ì§€ì—° (ë§ŒíšŒëŒ€ì±… í•„ìš”)';
                spiStatus.style.color = '#eb3349';
            }

            // CPI
            const cpiEl = document.getElementById('cpiValue');
            cpiEl.textContent = cpi.toFixed(2);
            cpiEl.className = 'gauge-label ' + (cpi >= 1.0 ? 'good' : cpi >= 0.9 ? 'normal' : 'bad');
            
            const cpiStatus = document.getElementById('cpiStatus');
            if (cpi >= 1.0) {
                cpiStatus.textContent = 'âœ… ì›ê°€ ì ˆê° (ì˜ˆì‚° ëŒ€ë¹„ ì ˆê°)';
                cpiStatus.style.color = '#56ab2f';
            } else if (cpi >= 0.9) {
                cpiStatus.textContent = 'âš ï¸ ì •ìƒ ë²”ìœ„ (ì›ê°€ ì¤€ìˆ˜)';
                cpiStatus.style.color = '#f9d423';
            } else {
                cpiStatus.textContent = 'âŒ ì›ê°€ ì´ˆê³¼ (ì›ê°€ë¶„ì„ í•„ìš”)';
                cpiStatus.style.color = '#eb3349';
            }

            drawGauge('spiGauge', spi);
            drawGauge('cpiGauge', cpi);
            drawSCurve(wbs);
        }

        function drawGauge(containerId, value) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const normalizedValue = Math.min(Math.max(value, 0), 2);
            const percentage = (normalizedValue / 2) * 100;

            let color = '#56ab2f';
            if (value < 0.9) color = '#eb3349';
            else if (value < 1.0) color = '#f9d423';

            const svg = `
                <svg width="150" height="80" style="overflow: visible;">
                    <path d="M 20 75 A 55 55 0 0 1 130 75" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="15" stroke-linecap="round"/>
                    <path d="M 20 75 A 55 55 0 0 1 130 75" fill="none" stroke="${color}" stroke-width="15" 
                        stroke-linecap="round" stroke-dasharray="173" stroke-dashoffset="${173 - (173 * percentage / 100)}"/>
                </svg>
            `;

            const label = container.querySelector('.gauge-label');
            container.innerHTML = svg;
            container.appendChild(label);
        }

        function drawSCurve(wbsItems) {
            const svg = document.getElementById('sCurveSvg');
            if (!svg) return;

            const width = 600;
            const height = 300;
            const padding = 40;

            svg.innerHTML = '';
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

            // ê·¸ë¦¬ë“œ
            for (let i = 0; i <= 10; i++) {
                const y = padding + (height - 2 * padding) * i / 10;
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', padding);
                line.setAttribute('y1', y);
                line.setAttribute('x2', width - padding);
                line.setAttribute('y2', y);
                line.setAttribute('stroke', 'rgba(255,255,255,0.1)');
                line.setAttribute('stroke-width', '1');
                svg.appendChild(line);
            }

            // ê³„íšì„ 
            const plannedPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            let plannedD = `M ${padding} ${height - padding}`;
            for (let i = 0; i <= 10; i++) {
                const x = padding + (width - 2 * padding) * i / 10;
                const progress = i * 10;
                const y = height - padding - (height - 2 * padding) * progress / 100;
                plannedD += ` L ${x} ${y}`;
            }
            plannedPath.setAttribute('d', plannedD);
            plannedPath.setAttribute('fill', 'none');
            plannedPath.setAttribute('stroke', '#667eea');
            plannedPath.setAttribute('stroke-width', '3');
            svg.appendChild(plannedPath);

            // ì‹¤ì ì„ 
            if (wbsItems.length > 0) {
                const avgProgress = wbsItems.reduce((sum, w) => sum + (w.progress || 0), 0) / wbsItems.length;
                const actualPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                let actualD = `M ${padding} ${height - padding}`;
                const progressX = padding + (width - 2 * padding) * avgProgress / 100;
                const progressY = height - padding - (height - 2 * padding) * avgProgress / 100;
                actualD += ` L ${progressX} ${progressY}`;
                actualPath.setAttribute('d', actualD);
                actualPath.setAttribute('fill', 'none');
                actualPath.setAttribute('stroke', '#56ab2f');
                actualPath.setAttribute('stroke-width', '3');
                svg.appendChild(actualPath);
            }

            // ë²”ë¡€
            const legendPlan = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            legendPlan.setAttribute('x', padding + 20);
            legendPlan.setAttribute('y', 30);
            legendPlan.setAttribute('fill', '#667eea');
            legendPlan.setAttribute('font-size', '14');
            legendPlan.textContent = 'â” ê³„íš';
            svg.appendChild(legendPlan);

            const legendActual = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            legendActual.setAttribute('x', padding + 100);
            legendActual.setAttribute('y', 30);
            legendActual.setAttribute('fill', '#56ab2f');
            legendActual.setAttribute('font-size', '14');
            legendActual.textContent = 'â” ì‹¤ì ';
            svg.appendChild(legendActual);
        }

        // ==================== ì‘ì—…ì¼ë³´ ====================
        function loadDaily() {
            const daily = Storage.get('daily');
            const container = document.getElementById('dailyList');
            if (!container) return;

            if (daily.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">ì‘ì„±ëœ ì¼ë³´ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            container.innerHTML = daily.sort((a, b) => new Date(b.date) - new Date(a.date)).map(d => `
                <div class="site-card">
                    <strong>${d.date}</strong> - íˆ¬ì…: ${d.labor}ëª…<br>${d.work}
                </div>
            `).join('');
        }

        window.openDailyModal = function() {
            const modal = document.getElementById('dailyModal');
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 style="font-size: 1.5rem; font-weight: 700;">ì‘ì—…ì¼ë³´</h3>
                        <button onclick="closeModal('dailyModal')" class="modal-close">&times;</button>
                    </div>
                    <form onsubmit="saveDaily(event)">
                        <div class="form-group">
                            <label>ì‘ì„±ì¼ *</label>
                            <input type="date" id="dailyDate" value="${new Date().toISOString().split('T')[0]}" required>
                        </div>
                        <div class="form-group">
                            <label>ì‘ì—… ë‚´ìš© *</label>
                            <textarea id="dailyWork" required></textarea>
                        </div>
                        <div class="form-group">
                            <label>íˆ¬ì… ì¸ë ¥ (ëª…)</label>
                            <input type="number" id="dailyLabor" value="0">
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-success" style="flex: 1;">ì €ì¥</button>
                            <button type="button" onclick="closeModal('dailyModal')" class="btn btn-danger" style="flex: 1;">ì·¨ì†Œ</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.add('active');
        };

        window.saveDaily = function(e) {
            e.preventDefault();
            const daily = Storage.get('daily');
            daily.push({
                id: 'daily-' + Date.now(),
                date: document.getElementById('dailyDate').value,
                work: document.getElementById('dailyWork').value,
                labor: parseInt(document.getElementById('dailyLabor').value) || 0
            });
            Storage.set('daily', daily);
            closeModal('dailyModal');
            loadDaily();
            alert('ì‘ì—…ì¼ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        };

        // ==================== ì•ˆì „ê´€ë¦¬ ====================
        function loadSafety() {
            const risks = Storage.get('risks');
            const container = document.getElementById('riskList');
            if (!container) return;

            if (risks.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">ìœ„í—˜ì„±í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            container.innerHTML = risks.map(r => {
                const score = r.frequency * r.severity;
                let level = 'í•˜';
                if (score >= 12) level = 'ìƒ';
                else if (score >= 8) level = 'ì¤‘';
                return `
                    <div class="site-card">
                        <strong>${r.work}</strong> - ${r.type} (ìœ„í—˜ë„: ${level})<br>
                        ì¡°ì¹˜: ${r.measures}
                    </div>
                `;
            }).join('');
        }

        window.openRiskModal = function() {
            const modal = document.getElementById('riskModal');
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 style="font-size: 1.5rem; font-weight: 700;">ìœ„í—˜ì„±í‰ê°€</h3>
                        <button onclick="closeModal('riskModal')" class="modal-close">&times;</button>
                    </div>
                    <form onsubmit="saveRisk(event)">
                        <div class="form-group">
                            <label>ì‘ì—…ëª… *</label>
                            <input type="text" id="riskWork" required>
                        </div>
                        <div class="form-group">
                            <label>ìœ„í—˜ ìœ í˜• *</label>
                            <select id="riskType" required>
                                <option value="">ì„ íƒ</option>
                                <option value="ì¶”ë½">ì¶”ë½</option>
                                <option value="ë‚™í•˜">ë‚™í•˜</option>
                                <option value="í˜‘ì°©">í˜‘ì°©</option>
                                <option value="ê°ì „">ê°ì „</option>
                            </select>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>ë¹ˆë„ (1-4) *</label>
                                <input type="number" id="riskFreq" min="1" max="4" required>
                            </div>
                            <div class="form-group">
                                <label>ê°•ë„ (1-4) *</label>
                                <input type="number" id="riskSeverity" min="1" max="4" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ê°ì†ŒëŒ€ì±… *</label>
                            <textarea id="riskMeasures" required></textarea>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn btn-success" style="flex: 1;">ì €ì¥</button>
                            <button type="button" onclick="closeModal('riskModal')" class="btn btn-danger" style="flex: 1;">ì·¨ì†Œ</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.add('active');
        };

        window.saveRisk = function(e) {
            e.preventDefault();
            const risks = Storage.get('risks');
            risks.push({
                id: 'risk-' + Date.now(),
                work: document.getElementById('riskWork').value,
                type: document.getElementById('riskType').value,
                frequency: parseInt(document.getElementById('riskFreq').value),
                severity: parseInt(document.getElementById('riskSeverity').value),
                measures: document.getElementById('riskMeasures').value
            });
            Storage.set('risks', risks);
            closeModal('riskModal');
            loadSafety();
            alert('ìœ„í—˜ì„±í‰ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        };

        // ==================== ìœ í‹¸ë¦¬í‹° ====================
        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('active');
        };

        console.log('%cğŸ—ï¸ PMIS - WBS & EVM ì™„ì „ êµ¬í˜„', 'color: #667eea; font-size: 16px; font-weight: bold');
    </script>
</body>
</html>
