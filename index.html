<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê±´ì„¤í˜„ì¥ ê´€ë¦¬ ì‹œìŠ¤í…œ (PMIS)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            background-attachment: fixed;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
        }

        .container { max-width: 500px; margin: 0 auto; padding: 16px; }
        .app-container { max-width: 1400px; margin: 0 auto; padding: 16px; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: 1fr; }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .hidden { display: none !important; }
        
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-6 { margin-bottom: 24px; }
        .mb-8 { margin-bottom: 32px; }
        .mt-4 { margin-top: 16px; }
        .mt-2 { margin-top: 8px; }
        .p-4 { padding: 16px; }
        .p-6 { padding: 24px; }
        .p-8 { padding: 32px; }
        
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .font-bold { font-weight: 700; }
        
        .w-full { width: 100%; }
        .flex-1 { flex: 1; }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
        }

        .glass-dark {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            color: #fff;
            font-size: 14px;
            text-align: center;
        }

        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); }
        .btn-danger { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
        .btn-sm { padding: 8px 16px; font-size: 12px; }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: #fff;
            font-size: 14px;
            white-space: nowrap;
        }

        .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }

        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-safe { background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); }
        .badge-caution { background: linear-gradient(135deg, #f9d423 0%, #ff4e50 100%); }
        .badge-warning { background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%); }
        .badge-critical { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }

        .role-admin { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .role-manager { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .role-worker { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

        input, select, textarea {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            color: #fff;
            width: 100%;
            font-size: 14px;
        }

        input::placeholder, textarea::placeholder { color: rgba(255, 255, 255, 0.5); }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.15);
        }

        textarea { resize: vertical; min-height: 80px; font-family: inherit; }
        label { display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; }

        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th {
            background: rgba(102, 126, 234, 0.3);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }
        .data-table td { padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); font-size: 14px; }
        .data-table tr:hover { background: rgba(255, 255, 255, 0.05); }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: rgba(15, 12, 41, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            margin: 20px auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
        }

        .modal-close {
            font-size: 28px;
            cursor: pointer;
            color: #fff;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .form-section-title {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 16px;
            color: #a8edea;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .photo-item {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }

        .photo-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .photo-item-controls {
            padding: 8px;
        }

        .photo-item textarea {
            width: 100%;
            min-height: 60px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .photo-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(235, 51, 73, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .radio-label input[type="radio"] {
            width: auto;
            margin: 0;
        }

        .site-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .site-card-thumbnail {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .site-card-content {
            flex: 1;
        }

        .site-card-title {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .site-card-info {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .site-card-meta {
            font-size: 0.9em;
            color: #d1d5db;
        }

        .no-thumbnail {
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .donut-chart { width: 150px; height: 150px; margin: 0 auto; }
        .donut-segment { fill: none; stroke-width: 20; }

        .progress-warning {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
            margin-top: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .work-type-row {
            background: rgba(255, 255, 255, 0.03);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .work-type-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #a8edea;
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .min-h-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; }

        .text-gray-300 { color: #d1d5db; }
        .text-gray-400 { color: #9ca3af; }
        .text-red-400 { color: #f87171; }
        .text-green-400 { color: #4ade80; }

        @media (min-width: 768px) {
            .md-grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
            .md-grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        }

        @media (max-width: 768px) {
            .site-card {
                flex-direction: column;
            }
            .site-card-thumbnail, .no-thumbnail {
                width: 100%;
                height: 200px;
            }
        }

        .overflow-x-auto { overflow-x: auto; }
        .fade-in { animation: fadeIn 0.5s; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-success { color: #4ade80; }
        .message-error { color: #f87171; }
    </style>
</head>
<body>
    <!-- ì´ˆê¸° ì„ íƒ í™”ë©´ -->
    <div id="selectScreen" class="min-h-screen">
        <div class="container">
            <div class="glass p-8 fade-in text-center">
                <h1 class="text-3xl font-bold mb-2">ğŸ—ï¸ PMIS</h1>
                <p class="text-gray-300 mb-8">ê±´ì„¤í˜„ì¥ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
                
                <button onclick="showLogin()" class="btn btn-primary w-full mb-4">ë¡œê·¸ì¸</button>
                <button onclick="showSignup()" class="btn btn-success w-full">íšŒì›ê°€ì…</button>
            </div>
        </div>
    </div>

    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen" class="hidden min-h-screen">
        <div class="container">
            <div class="glass p-8 fade-in">
                <h1 class="text-3xl font-bold text-center mb-2">ğŸ—ï¸ ë¡œê·¸ì¸</h1>
                <p class="text-center text-gray-300 mb-8">ê±´ì„¤í˜„ì¥ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
                
                <form onsubmit="handleLogin(event)">
                    <div class="mb-4">
                        <label>ì´ë©”ì¼</label>
                        <input type="email" id="loginEmail" required placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="mb-6">
                        <label>ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="loginPassword" required placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <button type="submit" class="btn btn-primary w-full mb-4">ë¡œê·¸ì¸</button>
                    <button type="button" onclick="backToSelect()" class="btn btn-danger w-full">ëŒì•„ê°€ê¸°</button>
                    <p class="text-xs text-gray-400 mt-4 text-center">
                        ê´€ë¦¬ì ê³„ì •: admin@pmis.com
                    </p>
                </form>

                <div id="loginMessage" class="mt-4 text-center text-sm"></div>
            </div>
        </div>
    </div>

    <!-- íšŒì›ê°€ì… í™”ë©´ -->
    <div id="signupScreen" class="hidden min-h-screen">
        <div class="container">
            <div class="glass p-8 fade-in">
                <h1 class="text-3xl font-bold text-center mb-2">ğŸ—ï¸ íšŒì›ê°€ì…</h1>
                <p class="text-center text-gray-300 mb-8">ê±´ì„¤í˜„ì¥ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
                
                <form onsubmit="handleSignup(event)">
                    <div class="mb-4">
                        <label>ì´ë©”ì¼</label>
                        <input type="email" id="signupEmail" required placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="mb-4">
                        <label>ì´ë¦„</label>
                        <input type="text" id="signupName" required placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="mb-6">
                        <label>ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="signupPassword" required minlength="4" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <button type="submit" class="btn btn-primary w-full mb-4">ê°€ì… ì‹ ì²­</button>
                    <button type="button" onclick="backToSelect()" class="btn btn-danger w-full">ëŒì•„ê°€ê¸°</button>
                </form>

                <div id="signupMessage" class="mt-4 text-center text-sm"></div>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì•± -->
    <div id="appScreen" class="hidden">
        <div class="app-container">
            <!-- í—¤ë” -->
            <div class="glass p-4 mb-4 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold">ğŸ—ï¸ PMIS</h2>
                    <p class="text-sm text-gray-300" id="userInfo"></p>
                </div>
                <button onclick="logout()" class="btn btn-danger btn-sm">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <!-- íƒ­ ë©”ë‰´ -->
            <div class="glass p-4 mb-4 overflow-x-auto">
                <div class="flex gap-2" style="min-width: max-content;">
                    <button class="tab active" onclick="switchTab('dashboard')" id="tabDashboard">ëŒ€ì‹œë³´ë“œ</button>
                    <button class="tab" onclick="switchTab('sites')" id="tabSites">í˜„ì¥ê´€ë¦¬</button>
                    <button class="tab hidden" onclick="switchTab('pending')" id="tabPending">ê°€ì…ìŠ¹ì¸</button>
                </div>
            </div>

            <!-- ëŒ€ì‹œë³´ë“œ -->
            <div id="contentDashboard" class="fade-in">
                <div class="grid grid-cols-1 md-grid-cols-2 gap-4 mb-4">
                    <div class="glass-dark p-6">
                        <h3 class="text-lg font-bold mb-4">í‰ê·  ê³µì •ë¥ </h3>
                        <div class="donut-chart" id="progressChart"></div>
                        <p class="text-center mt-4 text-2xl font-bold" id="avgProgress">0%</p>
                    </div>
                    <div class="glass-dark p-6">
                        <h3 class="text-lg font-bold mb-4">í˜„ì¥ í†µê³„</h3>
                        <div id="statsInfo" class="text-center mt-6">
                            <div class="mb-4">
                                <div class="text-gray-400 text-sm">ì´ í˜„ì¥ ìˆ˜</div>
                                <div class="text-3xl font-bold mt-2" id="totalSites">0</div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mt-6">
                                <div>
                                    <div class="text-xs text-gray-400">ì•ˆì „</div>
                                    <div class="text-xl font-bold text-green-400" id="safeSites">0</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-400">ì£¼ì˜</div>
                                    <div class="text-xl font-bold" style="color: #f9d423" id="cautionSites">0</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-400">ê²½ê³ </div>
                                    <div class="text-xl font-bold" style="color: #ff9966" id="warningSites">0</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-400">ì‹¬ê°</div>
                                    <div class="text-xl font-bold text-red-400" id="criticalSites">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-dark p-6">
                    <h3 class="text-lg font-bold mb-4">í˜„ì¥ ëª©ë¡</h3>
                    <div id="siteCardList"></div>
                </div>
            </div>

            <!-- í˜„ì¥ê´€ë¦¬ -->
            <div id="contentSites" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">í˜„ì¥ ê´€ë¦¬</h2>
                    <button onclick="openSiteModal()" class="btn btn-primary">+ í˜„ì¥ ì¶”ê°€</button>
                </div>
                <div id="mySitesList"></div>
            </div>

            <!-- ê°€ì…ìŠ¹ì¸ -->
            <div id="contentPending" class="hidden">
                <h2 class="text-2xl font-bold mb-4">ê°€ì… ìŠ¹ì¸</h2>
                <div class="glass-dark p-6">
                    <div class="overflow-x-auto">
                        <table class="data-table" id="pendingTable">
                            <thead><tr><th>ì´ë©”ì¼</th><th>ì´ë¦„</th><th>ì‹ ì²­ì¼</th><th>ìŠ¹ì¸</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í˜„ì¥ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="siteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-2xl font-bold">í˜„ì¥ ë“±ë¡</h3>
                <button onclick="closeSiteModal()" class="modal-close">&times;</button>
            </div>
            
            <form onsubmit="saveSite(event)" id="siteForm">
                <input type="hidden" id="siteId">

                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="form-section">
                    <div class="form-section-title">ğŸ“‹ ê¸°ë³¸ ì •ë³´</div>
                    <div class="mb-4">
                        <label>ê³µì‚¬ëª… *</label>
                        <input type="text" id="siteName" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label>ì‹œì‘ì¼ *</label>
                            <input type="date" id="siteStartDate" required>
                        </div>
                        <div>
                            <label>ì¢…ë£Œì˜ˆì •ì¼ *</label>
                            <input type="date" id="siteEndDate" required>
                        </div>
                    </div>
                </div>

                <!-- ê³µì‚¬ê¸ˆì•¡ -->
                <div class="form-section">
                    <div class="form-section-title">ğŸ’° ê³µì‚¬ê¸ˆì•¡ (ë°±ë§Œì›)</div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label>ê±´ì¶•</label>
                            <input type="number" id="costArch" value="0" min="0">
                        </div>
                        <div>
                            <label>ì „ê¸°</label>
                            <input type="number" id="costElec" value="0" min="0">
                        </div>
                        <div>
                            <label>í†µì‹ </label>
                            <input type="number" id="costComm" value="0" min="0">
                        </div>
                        <div>
                            <label>ì†Œë°©</label>
                            <input type="number" id="costFire" value="0" min="0">
                        </div>
                        <div>
                            <label>íê¸°ë¬¼</label>
                            <input type="number" id="costWaste" value="0" min="0">
                        </div>
                        <div>
                            <label>ê¸°íƒ€</label>
                            <input type="number" id="costOther" value="0" min="0">
                        </div>
                    </div>
                </div>

                <!-- ì „ì²´ ê³µì •ë¥  -->
                <div class="form-section">
                    <div class="form-section-title">ğŸ“Š ì „ì²´ ê³µì •ë¥ </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label>ê³„íš ê³µì •ë¥  (%) *</label>
                            <input type="number" id="plannedProgress" min="0" max="100" value="0" required>
                        </div>
                        <div>
                            <label>ì‹¤ì œ ê³µì •ë¥  (%) *</label>
                            <input type="number" id="actualProgress" min="0" max="100" value="0" required>
                        </div>
                    </div>
                </div>

                <!-- ì„¸ë¶€ ê³µì¢…ë³„ í˜„í™© -->
                <div class="form-section">
                    <div class="form-section-title">ğŸ”§ ì„¸ë¶€ ê³µì¢…ë³„ í˜„í™©</div>
                    <div id="workTypesContainer"></div>
                </div>

                <!-- ê´€ë¦¬ í•­ëª© -->
                <div class="form-section">
                    <div class="form-section-title">ğŸ“ ê´€ë¦¬ í•­ëª©</div>
                    <div class="mb-4">
                        <label>ì•ˆì „ì ê²€ (ì•ˆì „ ì¡°ì¹˜ì‚¬í•­)</label>
                        <textarea id="safetyCheck"></textarea>
                    </div>
                    <div class="mb-4">
                        <label>ê³µì •íšŒì˜ ë‚´ìš©</label>
                        <textarea id="meetingNotes"></textarea>
                    </div>
                    <div class="mb-4">
                        <label>ì¤‘ìš” ë³´ê³ ì‚¬í•­</label>
                        <textarea id="importantNotes"></textarea>
                    </div>
                </div>

                <!-- ì‚¬ì§„ ì—…ë¡œë“œ -->
                <div class="form-section">
                    <div class="form-section-title">ğŸ“· í˜„ì¥ ì‚¬ì§„</div>
                    <button type="button" onclick="addPhoto()" class="btn btn-success mb-4">+ ì‚¬ì§„ ì¶”ê°€</button>
                    <div id="photoContainer" class="photo-grid"></div>
                </div>

                <div class="flex gap-4 mt-6">
                    <button type="submit" class="btn btn-success flex-1">ì €ì¥</button>
                    <button type="button" onclick="closeSiteModal()" class="btn btn-danger flex-1">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==================== ë°ì´í„° ê´€ë¦¬ ====================
        class Store {
            static get(key) {
                try { return JSON.parse(localStorage.getItem(key)) || []; }
                catch { return []; }
            }
            static set(key, val) { 
                try {
                    localStorage.setItem(key, JSON.stringify(val)); 
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        alert('ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì¼ë¶€ ì‚¬ì§„ì„ ì‚­ì œí•´ì£¼ì„¸ìš”.');
                    }
                }
            }
            static getObj(key) {
                try { return JSON.parse(localStorage.getItem(key)) || {}; }
                catch { return {}; }
            }
        }

        // ê´€ë¦¬ì ê³„ì • ì´ˆê¸°í™”
        function init() {
            const users = Store.get('users');
            if (!users.find(u => u.email === 'admin@pmis.com')) {
                users.push({
                    id: 'admin-001',
                    email: 'admin@pmis.com',
                    password: '1234',
                    name: 'ì‹œìŠ¤í…œ ê´€ë¦¬ì',
                    role: 'admin',
                    approved: true
                });
                Store.set('users', users);
            }
            initWorkTypes();
        }

        let user = null;
        let currentPhotos = [];
        const WORK_TYPES = ['ì² ê±°', 'í† ëª©', 'ê±´ì¶•', 'ê¸°ê³„', 'ì „ê¸°', 'í†µì‹ ', 'ì†Œë°©', 'ê¸°íƒ€'];

        function initWorkTypes() {
            const container = document.getElementById('workTypesContainer');
            if (!container) return;
            
            container.innerHTML = WORK_TYPES.map(type => `
                <div class="work-type-row">
                    <div class="work-type-title">${type}</div>
                    <div class="input-group">
                        <div>
                            <label>ê³µì •ë¥  (%)</label>
                            <input type="number" id="work_${type}_progress" min="0" max="100" value="0">
                        </div>
                        <div>
                            <label>ê³µì •ë‚´ìš©</label>
                            <input type="text" id="work_${type}_content">
                        </div>
                        <div>
                            <label>íŠ¹ê¸°ì‚¬í•­</label>
                            <input type="text" id="work_${type}_notes">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ==================== ì¸ì¦ ====================
        function showLogin() {
            hide('selectScreen');
            show('loginScreen');
        }

        function showSignup() {
            hide('selectScreen');
            show('signupScreen');
        }

        function backToSelect() {
            hide('loginScreen');
            hide('signupScreen');
            show('selectScreen');
            document.getElementById('loginMessage').textContent = '';
            document.getElementById('signupMessage').textContent = '';
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            const users = Store.get('users');
            const found = users.find(u => u.email === email && u.password === password);

            if (!found) {
                showMsg('loginMessage', 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            if (!found.approved) {
                showMsg('loginMessage', 'ê´€ë¦¬ìì˜ ìŠ¹ì¸ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            user = found;
            Store.set('currentUser', found);
            showApp();
        }

        function handleSignup(e) {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value.trim();
            const name = document.getElementById('signupName').value.trim();
            const password = document.getElementById('signupPassword').value.trim();

            const users = Store.get('users');
            
            if (users.find(u => u.email === email)) {
                showMsg('signupMessage', 'ì´ë¯¸ ë“±ë¡ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.', 'error');
                return;
            }

            users.push({
                id: 'user-' + Date.now(),
                email, name, password,
                role: 'worker',
                approved: false,
                createdAt: new Date().toISOString()
            });

            Store.set('users', users);
            showMsg('signupMessage', 'ê°€ì… ì‹ ì²­ ì™„ë£Œ! ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'success');
            
            setTimeout(() => {
                document.getElementById('signupEmail').value = '';
                document.getElementById('signupName').value = '';
                document.getElementById('signupPassword').value = '';
            }, 2000);
        }

        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                user = null;
                localStorage.removeItem('currentUser');
                hide('appScreen');
                show('selectScreen');
            }
        }

        function showApp() {
            hide('loginScreen');
            show('appScreen');

            const roles = { 'admin': 'ê´€ë¦¬ì', 'manager': 'ì±…ì„ì', 'worker': 'ì‹¤ë¬´ì' };
            document.getElementById('userInfo').innerHTML = `
                <span class="badge role-${user.role}">${roles[user.role]}</span>
                ${user.name} (${user.email})
            `;

            if (user.role === 'admin') {
                show('tabPending');
            }

            loadDashboard();
        }

        // ==================== íƒ­ ì „í™˜ ====================
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('[id^="content"]').forEach(c => hide(c.id));

            const tabEl = document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1));
            const contentEl = document.getElementById('content' + tab.charAt(0).toUpperCase() + tab.slice(1));
            
            if (tabEl) tabEl.classList.add('active');
            if (contentEl) show(contentEl.id);

            if (tab === 'dashboard') loadDashboard();
            else if (tab === 'sites') loadMySites();
            else if (tab === 'pending') loadPending();
        }

        // ==================== ëŒ€ì‹œë³´ë“œ ====================
        function loadDashboard() {
            const sites = Store.get('sites');
            let displaySites = user.role === 'admin' ? sites : sites.filter(s => s.ownerId === user.id);

            // í†µê³„ ê³„ì‚°
            const stats = {
                safe: 0,
                caution: 0,
                warning: 0,
                critical: 0
            };

            displaySites.forEach(site => {
                const status = calculateStatus(site.plannedProgress || 0, site.actualProgress || 0);
                if (status === 'safe') stats.safe++;
                else if (status === 'caution') stats.caution++;
                else if (status === 'warning') stats.warning++;
                else if (status === 'critical') stats.critical++;
            });

            document.getElementById('totalSites').textContent = displaySites.length;
            document.getElementById('safeSites').textContent = stats.safe;
            document.getElementById('cautionSites').textContent = stats.caution;
            document.getElementById('warningSites').textContent = stats.warning;
            document.getElementById('criticalSites').textContent = stats.critical;

            // í‰ê·  ê³µì •ë¥ 
            const avgProgress = displaySites.length > 0 
                ? Math.round(displaySites.reduce((sum, s) => sum + (s.actualProgress || 0), 0) / displaySites.length)
                : 0;

            drawChart('progressChart', avgProgress, '#667eea');
            document.getElementById('avgProgress').textContent = avgProgress + '%';

            // í˜„ì¥ ì¹´ë“œ ë¦¬ìŠ¤íŠ¸
            renderSiteCards(displaySites);
        }

        function renderSiteCards(sites) {
            const container = document.getElementById('siteCardList');
            if (!sites.length) {
                container.innerHTML = '<div class="text-center text-gray-400 p-8">ë“±ë¡ëœ í˜„ì¥ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            container.innerHTML = sites.map(site => {
                const status = calculateStatus(site.plannedProgress || 0, site.actualProgress || 0);
                const statusInfo = getStatusInfo(status);
                const owner = Store.get('users').find(u => u.id === site.ownerId);
                const thumbnail = site.photos?.find(p => p.isMain)?.data || site.photos?.[0]?.data;

                return `
                    <div class="site-card">
                        ${thumbnail 
                            ? `<img src="${thumbnail}" class="site-card-thumbnail" alt="í˜„ì¥ì‚¬ì§„">`
                            : `<div class="no-thumbnail">ì‚¬ì§„ ì—†ìŒ</div>`
                        }
                        <div class="site-card-content">
                            <div class="site-card-title">${site.name}</div>
                            <div class="site-card-info">
                                <div class="site-card-meta">
                                    <strong>ê³µì •ë¥ :</strong> ê³„íš ${site.plannedProgress}% / ì‹¤ì œ ${site.actualProgress}%
                                </div>
                                <div>
                                    <span class="badge badge-${status}">${statusInfo.text}</span>
                                </div>
                                ${user.role === 'admin' ? `
                                    <div class="site-card-meta">
                                        <strong>ë‹´ë‹¹ì:</strong> ${owner ? owner.name : '-'}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="site-card-meta">
                                <strong>ê³µì‚¬ê¸°ê°„:</strong> ${site.startDate} ~ ${site.endDate}
                            </div>
                            ${site.importantNotes ? `
                                <div class="mt-2">
                                    <div class="text-sm text-gray-400">ì¤‘ìš” ë³´ê³ ì‚¬í•­</div>
                                    <div class="text-sm mt-1">${site.importantNotes}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function calculateStatus(planned, actual) {
            if (planned === 0) return 'safe';
            const ratio = (actual / planned) * 100;
            if (ratio >= 100) return 'safe';
            if (ratio >= 95) return 'caution';
            if (ratio >= 90) return 'warning';
            return 'critical';
        }

        function getStatusInfo(status) {
            const info = {
                safe: { text: 'ì•ˆì „', color: '#56ab2f' },
                caution: { text: 'ì£¼ì˜', color: '#f9d423' },
                warning: { text: 'ê²½ê³ ', color: '#ff9966' },
                critical: { text: 'ì‹¬ê°', color: '#eb3349' }
            };
            return info[status] || info.safe;
        }

        function drawChart(id, percent, color) {
            const el = document.getElementById(id);
            if (!el) return;
            const r = 65;
            const c = 2 * Math.PI * r;
            const o = c - (percent / 100 * c);

            el.innerHTML = `
                <svg width="150" height="150" style="transform: rotate(-90deg);">
                    <circle cx="75" cy="75" r="${r}" class="donut-segment" stroke="rgba(255,255,255,0.1)" />
                    <circle cx="75" cy="75" r="${r}" class="donut-segment" stroke="${color}" 
                        stroke-dasharray="${c}" stroke-dashoffset="${o}" />
                    <text x="75" y="80" text-anchor="middle" fill="#fff" font-size="24" font-weight="bold" 
                        transform="rotate(90 75 75)">${percent}%</text>
                </svg>
            `;
        }

        // ==================== í˜„ì¥ ê´€ë¦¬ ====================
        function loadMySites() {
            const sites = Store.get('sites').filter(s => s.ownerId === user.id);
            renderSiteCards(sites);
            document.getElementById('mySitesList').innerHTML = document.getElementById('siteCardList').innerHTML;
        }

        function openSiteModal() {
            currentPhotos = [];
            document.getElementById('siteForm').reset();
            document.getElementById('siteId').value = '';
            document.getElementById('photoContainer').innerHTML = '';
            initWorkTypes();
            show('siteModal');
        }

        function closeSiteModal() {
            hide('siteModal');
            currentPhotos = [];
        }

        function addPhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    resizeImage(file, (resizedData) => {
                        const photo = {
                            id: Date.now() + Math.random(),
                            data: resizedData,
                            description: '',
                            isMain: currentPhotos.length === 0
                        };
                        currentPhotos.push(photo);
                        renderPhotos();
                    });
                }
            };
            input.click();
        }

        function resizeImage(file, callback) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > 800) {
                        height = (height * 800) / width;
                        width = 800;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    const resizedData = canvas.toDataURL('image/jpeg', 0.7);
                    callback(resizedData);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function renderPhotos() {
            const container = document.getElementById('photoContainer');
            container.innerHTML = currentPhotos.map((photo, idx) => `
                <div class="photo-item">
                    <img src="${photo.data}" alt="í˜„ì¥ì‚¬ì§„">
                    <button type="button" class="photo-delete" onclick="deletePhoto(${idx})">&times;</button>
                    <div class="photo-item-controls">
                        <textarea placeholder="ì‚¬ì§„ ì„¤ëª… (100ì)" maxlength="100" 
                            onchange="updatePhotoDesc(${idx}, this.value)">${photo.description}</textarea>
                        <label class="radio-label">
                            <input type="radio" name="mainPhoto" ${photo.isMain ? 'checked' : ''} 
                                onchange="setMainPhoto(${idx})">
                            ëŒ€í‘œ ì‚¬ì§„
                        </label>
                    </div>
                </div>
            `).join('');
        }

        function deletePhoto(idx) {
            currentPhotos.splice(idx, 1);
            if (currentPhotos.length > 0 && !currentPhotos.some(p => p.isMain)) {
                currentPhotos[0].isMain = true;
            }
            renderPhotos();
        }

        function updatePhotoDesc(idx, desc) {
            currentPhotos[idx].description = desc;
        }

        function setMainPhoto(idx) {
            currentPhotos.forEach((p, i) => p.isMain = i === idx);
        }

        function saveSite(e) {
            e.preventDefault();

            const sites = Store.get('sites');
            const siteId = document.getElementById('siteId').value || 'site-' + Date.now();

            // ê³µì¢…ë³„ ë°ì´í„° ìˆ˜ì§‘
            const workTypes = {};
            WORK_TYPES.forEach(type => {
                workTypes[type] = {
                    progress: parseInt(document.getElementById(`work_${type}_progress`).value) || 0,
                    content: document.getElementById(`work_${type}_content`).value,
                    notes: document.getElementById(`work_${type}_notes`).value
                };
            });

            const site = {
                id: siteId,
                name: document.getElementById('siteName').value,
                startDate: document.getElementById('siteStartDate').value,
                endDate: document.getElementById('siteEndDate').value,
                costs: {
                    arch: parseInt(document.getElementById('costArch').value) || 0,
                    elec: parseInt(document.getElementById('costElec').value) || 0,
                    comm: parseInt(document.getElementById('costComm').value) || 0,
                    fire: parseInt(document.getElementById('costFire').value) || 0,
                    waste: parseInt(document.getElementById('costWaste').value) || 0,
                    other: parseInt(document.getElementById('costOther').value) || 0
                },
                plannedProgress: parseInt(document.getElementById('plannedProgress').value) || 0,
                actualProgress: parseInt(document.getElementById('actualProgress').value) || 0,
                workTypes: workTypes,
                safetyCheck: document.getElementById('safetyCheck').value,
                meetingNotes: document.getElementById('meetingNotes').value,
                importantNotes: document.getElementById('importantNotes').value,
                photos: currentPhotos,
                ownerId: user.id,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            const idx = sites.findIndex(s => s.id === siteId);
            if (idx >= 0) {
                sites[idx] = { ...sites[idx], ...site };
            } else {
                sites.push(site);
            }

            Store.set('sites', sites);
            closeSiteModal();
            loadDashboard();
            if (user.role !== 'admin') {
                loadMySites();
            }
            alert('í˜„ì¥ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ==================== ê°€ì… ìŠ¹ì¸ ====================
        function loadPending() {
            const users = Store.get('users').filter(u => !u.approved);
            const tbody = document.querySelector('#pendingTable tbody');
            tbody.innerHTML = '';

            users.forEach(u => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${u.email}</td>
                    <td>${u.name}</td>
                    <td>${new Date(u.createdAt).toLocaleDateString('ko-KR')}</td>
                    <td>
                        <button onclick="approve('${u.id}')" class="btn btn-success btn-sm">ìŠ¹ì¸</button>
                        <button onclick="reject('${u.id}')" class="btn btn-danger btn-sm">ê±°ë¶€</button>
                    </td>
                `;
            });

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-400">ìŠ¹ì¸ ëŒ€ê¸°ì¤‘ì¸ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            }
        }

        function approve(id) {
            if (confirm('ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const users = Store.get('users');
                const u = users.find(x => x.id === id);
                if (u) {
                    u.approved = true;
                    Store.set('users', users);
                    loadPending();
                    alert('ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        function reject(id) {
            if (confirm('ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const users = Store.get('users').filter(x => x.id !== id);
                Store.set('users', users);
                loadPending();
                alert('ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ==================== ìœ í‹¸ë¦¬í‹° ====================
        function showMsg(id, msg, type) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.className = 'mt-4 text-center text-sm message-' + type;
        }

        function hide(id) {
            const el = document.getElementById(id);
            if (el) el.classList.add('hidden');
        }

        function show(id) {
            const el = document.getElementById(id);
            if (el) el.classList.remove('hidden');
        }

        // ==================== ì´ˆê¸°í™” ====================
        window.addEventListener('DOMContentLoaded', () => {
            init();
            const saved = Store.getObj('currentUser');
            if (saved && saved.id) {
                const users = Store.get('users');
                const found = users.find(u => u.id === saved.id);
                if (found && found.approved) {
                    user = found;
                    hide('selectScreen');
                    showApp();
                }
            }
        });
    </script>
</body>
</html>