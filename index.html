<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì°¨ì„¸ëŒ€ ê±´ì„¤ì‚¬ì—…ê´€ë¦¬ì‹œìŠ¤í…œ (PMIS)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            background-attachment: fixed;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
        }

        .container { max-width: 500px; margin: 0 auto; padding: 16px; }
        .app-container { max-width: 1600px; margin: 0 auto; padding: 16px; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: 1fr; }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .hidden { display: none !important; }
        
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-6 { margin-bottom: 24px; }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .p-4 { padding: 16px; }
        .p-6 { padding: 24px; }
        .p-8 { padding: 32px; }
        
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .font-bold { font-weight: 700; }
        
        .w-full { width: 100%; }
        .flex-1 { flex: 1; }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
        }

        .glass-dark {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            color: #fff;
            font-size: 14px;
            text-align: center;
        }

        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); }
        .btn-danger { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
        .btn-sm { padding: 8px 16px; font-size: 12px; }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: #fff;
            font-size: 14px;
            white-space: nowrap;
        }

        .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }

        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-safe { background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); }
        .badge-caution { background: linear-gradient(135deg, #f9d423 0%, #ff4e50 100%); }
        .badge-warning { background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%); }
        .badge-critical { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }

        .role-admin { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }

        input, select, textarea {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            color: #fff;
            width: 100%;
            font-size: 14px;
        }

        input::placeholder { color: rgba(255, 255, 255, 0.5); }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.15);
        }

        textarea { resize: vertical; min-height: 80px; font-family: inherit; }
        label { display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; }

        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th {
            background: rgba(102, 126, 234, 0.3);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }
        .data-table td { padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); font-size: 14px; }
        .data-table tr:hover { background: rgba(255, 255, 255, 0.05); }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: rgba(15, 12, 41, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            margin: 20px auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
        }

        .modal-close {
            font-size: 28px;
            cursor: pointer;
            color: #fff;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .form-section-title {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 16px;
            color: #a8edea;
        }

        .site-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .site-card-thumbnail {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            object-fit: cover;
            margin-right: 20px;
        }

        .no-thumbnail {
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.9em;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .photo-item {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }

        .photo-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .photo-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(235, 51, 73, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
        }

        .evm-card {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .evm-value {
            font-size: 2em;
            font-weight: 700;
            margin-top: 8px;
        }

        .min-h-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .text-gray-300 { color: #d1d5db; }
        .text-gray-400 { color: #9ca3af; }

        @media (min-width: 768px) {
            .md-grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
            .md-grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
            .md-grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
        }

        .overflow-x-auto { overflow-x: auto; }
        .fade-in { animation: fadeIn 0.5s; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-success { color: #4ade80; }
        .message-error { color: #f87171; }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen" class="min-h-screen">
        <div class="container">
            <div class="glass p-8 fade-in">
                <h1 class="text-3xl font-bold text-center mb-2">ğŸ—ï¸ ì°¨ì„¸ëŒ€ PMIS</h1>
                <p class="text-center text-gray-300 mb-8">ê±´ì„¤ì‚¬ì—…ê´€ë¦¬ì‹œìŠ¤í…œ</p>
                
                <form onsubmit="handleLogin(event)">
                    <div class="mb-4">
                        <label>ì´ë©”ì¼</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="mb-6">
                        <label>ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-full">ë¡œê·¸ì¸</button>
                    <p class="text-xs text-gray-400 mt-4 text-center">
                        ê´€ë¦¬ì ê³„ì •: admin@pmis.com / 1234
                    </p>
                </form>

                <div id="loginMessage" class="mt-4 text-center text-sm"></div>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì•± -->
    <div id="appScreen" class="hidden">
        <div class="app-container">
            <div class="glass p-4 mb-4 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold">ğŸ—ï¸ ì°¨ì„¸ëŒ€ PMIS</h2>
                    <p class="text-sm text-gray-300" id="userInfo"></p>
                </div>
                <button onclick="logout()" class="btn btn-danger btn-sm">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <div class="glass p-4 mb-4 overflow-x-auto">
                <div class="flex gap-2" style="min-width: max-content;">
                    <button class="tab active" onclick="switchTab('dashboard')" id="tabDashboard">ëŒ€ì‹œë³´ë“œ</button>
                    <button class="tab" onclick="switchTab('sites')" id="tabSites">í˜„ì¥ê´€ë¦¬</button>
                    <button class="tab" onclick="switchTab('wbs')" id="tabWBS">WBS</button>
                    <button class="tab" onclick="switchTab('evm')" id="tabEVM">EVM ë¶„ì„</button>
                    <button class="tab" onclick="switchTab('safety')" id="tabSafety">ì•ˆì „ê´€ë¦¬</button>
                </div>
            </div>

            <!-- ëŒ€ì‹œë³´ë“œ -->
            <div id="contentDashboard" class="fade-in">
                <div class="grid grid-cols-1 md-grid-cols-4 gap-4 mb-4">
                    <div class="evm-card">
                        <div class="text-sm text-gray-400">ì´ í˜„ì¥ ìˆ˜</div>
                        <div class="evm-value" id="dashTotalSites">0</div>
                    </div>
                    <div class="evm-card">
                        <div class="text-sm text-gray-400">í‰ê·  ê³µì •ë¥ </div>
                        <div class="evm-value" id="dashAvgProgress">0%</div>
                    </div>
                    <div class="evm-card">
                        <div class="text-sm text-gray-400">ìœ„í—˜ì„±í‰ê°€</div>
                        <div class="evm-value" id="dashRisks">0ê±´</div>
                    </div>
                    <div class="evm-card">
                        <div class="text-sm text-gray-400">WBS í•­ëª©</div>
                        <div class="evm-value" id="dashWBS">0</div>
                    </div>
                </div>

                <div class="glass-dark p-6">
                    <h3 class="text-lg font-bold mb-4">ìµœê·¼ í˜„ì¥</h3>
                    <div id="dashSiteList"></div>
                </div>
            </div>

            <!-- í˜„ì¥ê´€ë¦¬ -->
            <div id="contentSites" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">í˜„ì¥ ê´€ë¦¬</h2>
                    <button onclick="openSiteModal()" class="btn btn-primary">+ í˜„ì¥ ì¶”ê°€</button>
                </div>
                <div id="sitesList"></div>
            </div>

            <!-- WBS ê´€ë¦¬ -->
            <div id="contentWBS" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">WBS ê´€ë¦¬</h2>
                    <button onclick="openWBSModal()" class="btn btn-primary">+ WBS ì¶”ê°€</button>
                </div>
                <div class="glass-dark p-6">
                    <div id="wbsList"></div>
                </div>
            </div>

            <!-- EVM ë¶„ì„ -->
            <div id="contentEVM" class="hidden">
                <h2 class="text-2xl font-bold mb-4">EVM ë¶„ì„</h2>
                <div class="grid grid-cols-1 md-grid-cols-4 gap-4">
                    <div class="evm-card">
                        <div class="text-sm text-gray-400">BAC (ì´ì˜ˆì‚°)</div>
                        <div class="evm-value" id="evmBAC">0ì–µ</div>
                    </div>
                    <div class="evm-card">
                        <div class="text-sm text-gray-400">PV (ê³„íšê³µì‚¬ë¹„)</div>
                        <div class="evm-value" id="evmPV">0ì–µ</div>
                    </div>
                    <div class="evm-card">
                        <div class="text-sm text-gray-400">EV (ë‹¬ì„±ê³µì‚¬ë¹„)</div>
                        <div class="evm-value" id="evmEV">0ì–µ</div>
                    </div>
                    <div class="evm-card">
                        <div class="text-sm text-gray-400">SPI</div>
                        <div class="evm-value" id="evmSPI">0.00</div>
                    </div>
                </div>
            </div>

            <!-- ì•ˆì „ê´€ë¦¬ -->
            <div id="contentSafety" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">ì•ˆì „ê´€ë¦¬</h2>
                    <button onclick="openRiskModal()" class="btn btn-primary">+ ìœ„í—˜ì„±í‰ê°€</button>
                </div>
                <div class="glass-dark p-6">
                    <div id="riskList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- í˜„ì¥ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="siteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-2xl font-bold">í˜„ì¥ ë“±ë¡</h3>
                <button onclick="closeSiteModal()" class="modal-close">&times;</button>
            </div>
            
            <form onsubmit="saveSite(event)">
                <input type="hidden" id="siteId">

                <div class="form-section">
                    <div class="form-section-title">ê¸°ë³¸ ì •ë³´</div>
                    <div class="mb-4">
                        <label>ê³µì‚¬ëª… *</label>
                        <input type="text" id="siteName" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label>ì‹œì‘ì¼ *</label>
                            <input type="date" id="siteStartDate" required>
                        </div>
                        <div>
                            <label>ì¢…ë£Œì˜ˆì •ì¼ *</label>
                            <input type="date" id="siteEndDate" required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">ê³µì •ë¥ </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label>ê³„íš ê³µì •ë¥  (%)</label>
                            <input type="number" id="plannedProgress" min="0" max="100" value="0">
                        </div>
                        <div>
                            <label>ì‹¤ì œ ê³µì •ë¥  (%)</label>
                            <input type="number" id="actualProgress" min="0" max="100" value="0">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">ê´€ë¦¬ í•­ëª©</div>
                    <div class="mb-4">
                        <label>ì¤‘ìš” ë³´ê³ ì‚¬í•­</label>
                        <textarea id="importantNotes"></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">ì‚¬ì§„ ì¶”ê°€</div>
                    <button type="button" onclick="addPhoto()" class="btn btn-success mb-4">+ ì‚¬ì§„ ì¶”ê°€</button>
                    <div id="photoContainer" class="photo-grid"></div>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="btn btn-success flex-1">ì €ì¥</button>
                    <button type="button" onclick="closeSiteModal()" class="btn btn-danger flex-1">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- WBS ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="wbsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="text-2xl font-bold">WBS ì¶”ê°€</h3>
                <button onclick="closeWBSModal()" class="modal-close">&times;</button>
            </div>
            
            <form onsubmit="saveWBS(event)">
                <div class="mb-4">
                    <label>WBS ì½”ë“œ *</label>
                    <input type="text" id="wbsCode" required placeholder="ì˜ˆ: 1.1.1">
                </div>
                <div class="mb-4">
                    <label>ì‘ì—…ëª… *</label>
                    <input type="text" id="wbsName" required>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label>ì˜ˆì‚° (ë°±ë§Œì›)</label>
                        <input type="number" id="wbsBudget" value="0">
                    </div>
                    <div>
                        <label>ì§„í–‰ë¥  (%)</label>
                        <input type="number" id="wbsProgress" min="0" max="100" value="0">
                    </div>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="btn btn-success flex-1">ì €ì¥</button>
                    <button type="button" onclick="closeWBSModal()" class="btn btn-danger flex-1">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ìœ„í—˜ì„±í‰ê°€ ëª¨ë‹¬ -->
    <div id="riskModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="text-2xl font-bold">ìœ„í—˜ì„±í‰ê°€</h3>
                <button onclick="closeRiskModal()" class="modal-close">&times;</button>
            </div>
            
            <form onsubmit="saveRisk(event)">
                <div class="mb-4">
                    <label>ì‘ì—…ëª…</label>
                    <input type="text" id="riskWork" required>
                </div>
                <div class="mb-4">
                    <label>ìœ„í—˜ ìœ í˜•</label>
                    <select id="riskType" required>
                        <option value="">ì„ íƒ</option>
                        <option value="ì¶”ë½">ì¶”ë½</option>
                        <option value="ë‚™í•˜">ë‚™í•˜</option>
                        <option value="í˜‘ì°©">í˜‘ì°©</option>
                        <option value="ê°ì „">ê°ì „</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label>ë¹ˆë„ (1-4)</label>
                        <input type="number" id="riskFreq" min="1" max="4" required>
                    </div>
                    <div>
                        <label>ê°•ë„ (1-4)</label>
                        <input type="number" id="riskSeverity" min="1" max="4" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label>ê°ì†ŒëŒ€ì±…</label>
                    <textarea id="riskMeasures" required></textarea>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="btn btn-success flex-1">ì €ì¥</button>
                    <button type="button" onclick="closeRiskModal()" class="btn btn-danger flex-1">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        class Store {
            static get(key) {
                try { return JSON.parse(localStorage.getItem(key)) || []; }
                catch { return []; }
            }
            static set(key, val) {
                try { localStorage.setItem(key, JSON.stringify(val)); }
                catch (e) { alert('ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'); }
            }
            static getObj(key) {
                try { return JSON.parse(localStorage.getItem(key)) || {}; }
                catch { return {}; }
            }
        }

        function init() {
            const users = Store.get('users');
            if (!users.find(u => u.email === 'admin@pmis.com')) {
                users.push({
                    id: 'admin-001',
                    email: 'admin@pmis.com',
                    password: '1234',
                    name: 'ì‹œìŠ¤í…œ ê´€ë¦¬ì',
                    role: 'admin',
                    approved: true
                });
                Store.set('users', users);
            }
        }

        let user = null;
        let currentPhotos = [];

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            const users = Store.get('users');
            const found = users.find(u => u.email === email && u.password === password);

            if (!found || !found.approved) {
                showMsg('loginMessage', 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            user = found;
            Store.set('currentUser', found);
            showApp();
        }

        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                user = null;
                localStorage.removeItem('currentUser');
                hide('appScreen');
                show('loginScreen');
            }
        }

        function showApp() {
            hide('loginScreen');
            show('appScreen');

            document.getElementById('userInfo').innerHTML = `
                <span class="badge role-admin">ê´€ë¦¬ì</span> ${user.name}
            `;

            loadDashboard();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('[id^="content"]').forEach(c => hide(c.id));

            const tabEl = document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1));
            const contentEl = document.getElementById('content' + tab.charAt(0).toUpperCase() + tab.slice(1));
            
            if (tabEl) tabEl.classList.add('active');
            if (contentEl) show(contentEl.id);

            if (tab === 'dashboard') loadDashboard();
            else if (tab === 'sites') loadSites();
            else if (tab === 'wbs') loadWBS();
            else if (tab === 'evm') loadEVM();
            else if (tab === 'safety') loadSafety();
        }

        function loadDashboard() {
            const sites = Store.get('sites');
            const wbs = Store.get('wbs');
            const risks = Store.get('risks');

            document.getElementById('dashTotalSites').textContent = sites.length;
            
            const avgProgress = sites.length > 0 
                ? Math.round(sites.reduce((sum, s) => sum + (s.actualProgress || 0), 0) / sites.length)
                : 0;
            document.getElementById('dashAvgProgress').textContent = avgProgress + '%';
            
            document.getElementById('dashRisks').textContent = risks.length + 'ê±´';
            document.getElementById('dashWBS').textContent = wbs.length;

            const container = document.getElementById('dashSiteList');
            if (sites.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 p-8">ë“±ë¡ëœ í˜„ì¥ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            container.innerHTML = sites.slice(0, 5).map(site => {
                const ratio = site.plannedProgress > 0 ? (site.actualProgress / site.plannedProgress) : 1;
                let statusClass = 'badge-safe';
                let statusText = 'ì•ˆì „';
                
                if (ratio < 0.90) { statusClass = 'badge-critical'; statusText = 'ì‹¬ê°'; }
                else if (ratio < 0.95) { statusClass = 'badge-warning'; statusText = 'ì£¼ì˜'; }
                else if (ratio < 1.00) { statusClass = 'badge-caution'; statusText = 'ë³´í†µ'; }

                return `
                    <div class="site-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <strong>${site.name}</strong>
                                <div class="text-sm text-gray-400">${site.startDate} ~ ${site.endDate}</div>
                            </div>
                            <span class="badge ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadSites() {
            const sites = Store.get('sites');
            const container = document.getElementById('sitesList');

            if (sites.length === 0) {
                container.innerHTML = '<div class="glass-dark p-6 text-center text-gray-400">ë“±ë¡ëœ í˜„ì¥ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            container.innerHTML = sites.map(site => {
                const ratio = site.plannedProgress > 0 ? (site.actualProgress / site.plannedProgress) : 1;
                let statusClass = 'badge-safe';
                
                if (ratio < 0.90) statusClass = 'badge-critical';
                else if (ratio < 0.95) statusClass = 'badge-warning';
                else if (ratio < 1.00) statusClass = 'badge-caution';

                const thumbnail = site.photos?.[0]?.data;

                return `
                    <div class="site-card">
                        <div class="flex gap-4">
                            ${thumbnail 
                                ? `<img src="${thumbnail}" class="site-card-thumbnail">`
                                : `<div class="no-thumbnail">ì‚¬ì§„ ì—†ìŒ</div>`
                            }
                            <div class="flex-1">
                                <h3 class="text-xl font-bold mb-2">${site.name}</h3>
                                <div class="text-sm text-gray-400 mb-2">${site.startDate} ~ ${site.endDate}</div>
                                <div class="mb-2">
                                    ê³„íš: ${site.plannedProgress}% | ì‹¤ì œ: ${site.actualProgress}%
                                    <span class="badge ${statusClass} ml-2">${Math.round(ratio * 100)}%</span>
                                </div>
                                ${site.importantNotes ? `<div class="text-sm text-gray-300">${site.importantNotes}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openSiteModal() {
            document.getElementById('siteId').value = '';
            document.getElementById('siteName').value = '';
            document.getElementById('siteStartDate').value = '';
            document.getElementById('siteEndDate').value = '';
            document.getElementById('plannedProgress').value = '0';
            document.getElementById('actualProgress').value = '0';
            document.getElementById('importantNotes').value = '';
            document.getElementById('photoContainer').innerHTML = '';
            currentPhotos = [];
            show('siteModal');
        }

        function closeSiteModal() {
            hide('siteModal');
        }

        function addPhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    resizeImage(file, (data) => {
                        currentPhotos.push({ id: Date.now(), data });
                        renderPhotos();
                    });
                }
            };
            input.click();
        }

        function resizeImage(file, callback) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > 800) {
                        height = (height * 800) / width;
                        width = 800;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    callback(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function renderPhotos() {
            const container = document.getElementById('photoContainer');
            container.innerHTML = currentPhotos.map((photo, idx) => `
                <div class="photo-item">
                    <img src="${photo.data}">
                    <button type="button" class="photo-delete" onclick="deletePhoto(${idx})">&times;</button>
                </div>
            `).join('');
        }

        function deletePhoto(idx) {
            currentPhotos.splice(idx, 1);
            renderPhotos();
        }

        function saveSite(e) {
            e.preventDefault();

            const sites = Store.get('sites');
            const site = {
                id: 'site-' + Date.now(),
                name: document.getElementById('siteName').value,
                startDate: document.getElementById('siteStartDate').value,
                endDate: document.getElementById('siteEndDate').value,
                plannedProgress: parseInt(document.getElementById('plannedProgress').value) || 0,
                actualProgress: parseInt(document.getElementById('actualProgress').value) || 0,
                importantNotes: document.getElementById('importantNotes').value,
                photos: currentPhotos,
                ownerId: user.id,
                createdAt: new Date().toISOString()
            };

            sites.push(site);
            Store.set('sites', sites);

            closeSiteModal();
            loadSites();
            loadDashboard();
            alert('í˜„ì¥ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function loadWBS() {
            const wbs = Store.get('wbs');
            const container = document.getElementById('wbsList');

            if (wbs.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 p-8">ë“±ë¡ëœ WBSê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            container.innerHTML = wbs.map(w => `
                <div class="site-card">
                    <div class="flex justify-between items-center">
                        <div>
                            <strong>${w.code}</strong> ${w.name}
                            <div class="text-sm text-gray-400">ì˜ˆì‚°: ${w.budget.toLocaleString()}ë°±ë§Œì› | ì§„í–‰ë¥ : ${w.progress}%</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openWBSModal() {
            document.getElementById('wbsCode').value = '';
            document.getElementById('wbsName').value = '';
            document.getElementById('wbsBudget').value = '0';
            document.getElementById('wbsProgress').value = '0';
            show('wbsModal');
        }

        function closeWBSModal() {
            hide('wbsModal');
        }

        function saveWBS(e) {
            e.preventDefault();

            const wbs = Store.get('wbs');
            wbs.push({
                id: 'wbs-' + Date.now(),
                code: document.getElementById('wbsCode').value,
                name: document.getElementById('wbsName').value,
                budget: parseInt(document.getElementById('wbsBudget').value) || 0,
                progress: parseInt(document.getElementById('wbsProgress').value) || 0,
                createdAt: new Date().toISOString()
            });

            Store.set('wbs', wbs);
            closeWBSModal();
            loadWBS();
            loadDashboard();
            alert('WBSê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function loadEVM() {
            const wbs = Store.get('wbs');
            const totalBudget = wbs.reduce((sum, w) => sum + w.budget, 0);
            const avgProgress = wbs.length > 0 
                ? wbs.reduce((sum, w) => sum + w.progress, 0) / wbs.length
                : 0;

            const bac = totalBudget;
            const pv = bac * 0.5; // ê°€ì •: ê³„íš 50%
            const ev = bac * (avgProgress / 100);
            const spi = pv > 0 ? (ev / pv) : 0;

            document.getElementById('evmBAC').textContent = (bac / 100).toFixed(1) + 'ì–µ';
            document.getElementById('evmPV').textContent = (pv / 100).toFixed(1) + 'ì–µ';
            document.getElementById('evmEV').textContent = (ev / 100).toFixed(1) + 'ì–µ';
            document.getElementById('evmSPI').textContent = spi.toFixed(2);
        }

        function loadSafety() {
            const risks = Store.get('risks');
            const container = document.getElementById('riskList');

            if (risks.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 p-8">ë“±ë¡ëœ ìœ„í—˜ì„±í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            container.innerHTML = risks.map(r => {
                const score = r.frequency * r.severity;
                let level = 'í•˜';
                if (score >= 12) level = 'ìƒ';
                else if (score >= 8) level = 'ì¤‘';

                return `
                    <div class="site-card">
                        <div>
                            <strong>${r.work}</strong> - ${r.type}
                            <span class="badge badge-${level === 'ìƒ' ? 'critical' : 'warning'} ml-2">${level}</span>
                            <div class="text-sm text-gray-400 mt-2">ì¡°ì¹˜: ${r.measures}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openRiskModal() {
            document.getElementById('riskWork').value = '';
            document.getElementById('riskType').value = '';
            document.getElementById('riskFreq').value = '';
            document.getElementById('riskSeverity').value = '';
            document.getElementById('riskMeasures').value = '';
            show('riskModal');
        }

        function closeRiskModal() {
            hide('riskModal');
        }

        function saveRisk(e) {
            e.preventDefault();

            const risks = Store.get('risks');
            risks.push({
                id: 'risk-' + Date.now(),
                work: document.getElementById('riskWork').value,
                type: document.getElementById('riskType').value,
                frequency: parseInt(document.getElementById('riskFreq').value),
                severity: parseInt(document.getElementById('riskSeverity').value),
                measures: document.getElementById('riskMeasures').value,
                date: new Date().toISOString()
            });

            Store.set('risks', risks);
            closeRiskModal();
            loadSafety();
            loadDashboard();
            alert('ìœ„í—˜ì„±í‰ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function showMsg(id, msg, type) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.className = 'mt-4 text-center text-sm message-' + type;
        }

        function hide(id) {
            const el = document.getElementById(id);
            if (el) el.classList.add('hidden');
        }

        function show(id) {
            const el = document.getElementById(id);
            if (el) el.classList.remove('hidden');
        }

        window.addEventListener('DOMContentLoaded', () => {
            init();
            const saved = Store.getObj('currentUser');
            if (saved && saved.id) {
                const users = Store.get('users');
                const found = users.find(u => u.id === saved.id && u.approved);
                if (found) {
                    user = found;
                    hide('loginScreen');
                    showApp();
                }
            }
        });
    </script>
</body>
</html>